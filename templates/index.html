<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jira AI Agent</title>
    <script src="https://unpkg.com/htmx.org@1.6.1"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="card">
        <h1>Jira AI Agent ðŸ¤–</h1>
        
        <!-- Command Form -->
        <form hx-post="/command" 
              hx-target="#response" 
              hx-swap="innerHTML"
              onsubmit="showProcessing()">
            <input type="text" 
                   name="command" 
                   placeholder="Create task in PROJECT: Update documentation..."
                   required>
            <button type="submit">Execute</button>
        </form>

        <!-- Status Messages -->
        <div id="processing-message" class="status processing" hidden>
            <i class="fas fa-spinner fa-spin"></i>
            <span>Processing your request...</span>
        </div>
        
        <div id="response"></div>
    </div>

    <script>
        function showProcessing() {
            const processingMsg = document.getElementById('processing-message');
            processingMsg.removeAttribute('hidden');
        }

        htmx.on('htmx:beforeRequest', function(evt) {
            // Clear the response element and show the processing message
            document.getElementById('response').innerHTML = '';
            showProcessing();
        });

        htmx.on('htmx:afterRequest', function(evt) {
            const processingMsg = document.getElementById('processing-message');
            processingMsg.setAttribute('hidden', 'true');

            if (evt.detail.successful) {
                const responseDiv = document.getElementById('response');

                // Parse the server JSON response to create a friendlier display
                let responseData;
                try {
                    responseData = JSON.parse(evt.detail.xhr.responseText);
                } catch (e) {
                    responseDiv.innerHTML = '<div class="status error"><i class="fa fa-exclamation-triangle"></i> Invalid JSON response</div>';
                    return;
                }

                if (responseData.success) {
                    // Separate each line into a list item or display as-is
                    const lines = responseData.result.split('\n');
                    let outputHtml = `<div class="status success"><i class="fa fa-check"></i><ul>`;
                    lines.forEach(line => {
                        if (line.trim()) {
                            outputHtml += `<li>${line}</li>`;
                        }
                    });
                    outputHtml += `</ul></div>`;
                    responseDiv.innerHTML = outputHtml;
                } else {
                    responseDiv.innerHTML = `<div class="status error"><i class="fa fa-exclamation-triangle"></i> ${responseData.error || 'Unknown error occurred'}</div>`;
                }
            }
        });
    </script>
</body>
</html>